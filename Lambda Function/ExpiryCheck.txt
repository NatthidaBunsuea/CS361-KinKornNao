import {
  DynamoDBClient,
  ScanCommand,
  PutItemCommand,
  QueryCommand,
} from "@aws-sdk/client-dynamodb";
import {
  CognitoIdentityProviderClient,
  AdminGetUserCommand,
} from "@aws-sdk/client-cognito-identity-provider";
import {
  SNSClient,
  PublishCommand,
  SubscribeCommand,
  ListSubscriptionsByTopicCommand,
} from "@aws-sdk/client-sns";

/* ===== CONFIG ‡∏à‡∏≤‡∏Å Environment ===== */
const region = process.env.AWS_REGION || "us-east-1";

const inventoryTable =
  process.env.INVENTORY_TABLE || "KKN-Inventory";        
const logTable =
  process.env.NOTI_LOG_TABLE || "KKN-NotificationLog";     
const userPoolId =
  process.env.USER_POOL_ID || "us-east-1_7OWzCRhFJ";       
const topicArn =
  process.env.EXPIRY_TOPIC_ARN ||
  "arn:aws:sns:us-east-1:905418263792:KKN";      
const DAILY_EMAIL_LIMIT = Number(process.env.DAILY_EMAIL_LIMIT || "10");
/* ================================== */

const ddb = new DynamoDBClient({ region });
const cognito = new CognitoIdentityProviderClient({ region });
const sns = new SNSClient({ region });

/**
 * ‡πÄ‡∏ä‡πá‡∏Å‡∏ß‡πà‡∏≤ email ‡∏ô‡∏µ‡πâ subscribe ‡∏Å‡∏±‡∏ö topic ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
 * ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á ‚Üí subscribe ‡πÉ‡∏´‡∏°‡πà
 */
async function ensureEmailSubscription(email) {
  if (!email) return;

  const existing = await sns.send(
    new ListSubscriptionsByTopicCommand({
      TopicArn: topicArn,
    })
  );

  const hasSub =
    existing.Subscriptions &&
    existing.Subscriptions.some(
      (sub) => sub.Endpoint === email && sub.Protocol === "email"
    );

  if (!hasSub) {
    console.log(`Subscribe email ${email} to ${topicArn}`);
    await sns.send(
      new SubscribeCommand({
        TopicArn: topicArn,
        Protocol: "email",
        Endpoint: email,
      })
    );
  }
}

/**
 * ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà userId ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
 */
async function getTodayEmailCount(userId, today) {
  console.log("getTodayEmailCount: start", { userId, today });

  const result = await ddb.send(
    new QueryCommand({
      TableName: logTable,
      KeyConditionExpression:
        "UserID = :uid AND begins_with(ExpiryKey, :date)",
      ExpressionAttributeValues: {
        ":uid": { S: userId },
        ":date": { S: today + "#email" },
      },
    })
  );

  console.log("getTodayEmailCount: result.Count =", result.Count);
  return result.Count || 0;
}

/**
 * ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log ‡∏ß‡πà‡∏≤‡∏™‡πà‡∏á‡πÄ‡∏°‡∏•‡πÉ‡∏´‡πâ userId ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô
 */
async function logEmailSent(userId, today, sequence) {
  const nowIso = new Date().toISOString();
  const key = `${today}#email#${String(sequence).padStart(2, "0")}`;

  console.log("logEmailSent: writing", {
    userId,
    key,
    nowIso,
    table: logTable,
  });

  try {
    await ddb.send(
      new PutItemCommand({
        TableName: logTable,
        Item: {
          UserID: { S: userId },
          ExpiryKey: { S: key },
          SentAt: { S: nowIso },
        },
      })
    );
    console.log("logEmailSent: SUCCESS", { userId, key });
  } catch (err) {
    console.error("logEmailSent: FAILED", { userId, key }, err);
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å
 */
export const handler = async (event) => {
  const now = new Date();
  const today = now.toISOString().split("T")[0];
  const in3Days = new Date(now.getTime() + 3 * 24 * 60 * 60 * 1000)
    .toISOString()
    .split("T")[0];

  // 1) ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  const scanResult = await ddb.send(
    new ScanCommand({
      TableName: inventoryTable,
    })
  );

  // grouped[userId] = ["item1 (...)", "item2 (...)"]
  const grouped = {};

  for (const item of scanResult.Items || []) {
    const expiry = item.ExpiryDate && item.ExpiryDate.S;

    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏≤‡πÉ‡∏ä‡πâ OwnerId ‡πÅ‡∏ó‡∏ô UserID
    const userId = item.OwnerId && item.OwnerId.S;      // <-- ‡πÅ‡∏Å‡πâ‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ

    if (!expiry || !userId) continue;

    let type = null;
    if (expiry === today) {
      type = "expired";
    } else if (expiry === in3Days) {
      type = "warning-3d";
    }

    if (!type) continue;

    if (!grouped[userId]) grouped[userId] = [];

    const alertText =
      type === "expired" ? "‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß" : "‡∏à‡∏∞‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ô‡∏≠‡∏µ‡∏Å 3 ‡∏ß‡∏±‡∏ô";

    const name = (item.Name && item.Name.S) || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠"; // <-- ‡πÅ‡∏Å‡πâ‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ

    grouped[userId].push(`${name} (${alertText}: ${expiry})`);
  }


  // 2) loop ‡∏ó‡∏µ‡∏•‡∏∞ user ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡πà‡∏á‡πÄ‡∏°‡∏•‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô limit
  for (const userId of Object.keys(grouped)) {
    try {
      // 2.1 ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• user ‡∏à‡∏≤‡∏Å Cognito
      const user = await cognito.send(
        new AdminGetUserCommand({
          Username: userId,
          UserPoolId: userPoolId,
        })
      );

      const emailAttr =
        user.UserAttributes &&
        user.UserAttributes.find((attr) => attr.Name === "email");
      const email = emailAttr && emailAttr.Value;

      if (!email) {
        console.log(`User ${userId} ‡πÑ‡∏°‡πà‡∏°‡∏µ email ‡πÉ‡∏ô Cognito`);
        continue;
      }

      // 2.2 subscribe email ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö SNS topic (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢)
      await ensureEmailSubscription(email);

      // 2.3 ‡πÄ‡∏ä‡πá‡∏Å daily limit
      const currentCount = await getTodayEmailCount(userId, today);
      if (currentCount >= DAILY_EMAIL_LIMIT) {
        console.log(
          `User ${userId} ‡πÄ‡∏Å‡∏¥‡∏ô daily limit ‡πÅ‡∏•‡πâ‡∏ß (${currentCount}/${DAILY_EMAIL_LIMIT})`
        );
        continue;
      }

      // 2.4 ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á
      const message =
        "üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏/‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏:\n\n" +
        grouped[userId].join("\n") +
        "\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏™‡∏µ‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞";

      // 2.5 ‡∏™‡πà‡∏á SNS ‚Üí Email
      await sns.send(
        new PublishCommand({
          TopicArn: topicArn,
          Message: message,
          Subject: "‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏",
        })
      );

      // 2.6 ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log
      await logEmailSent(userId, today, currentCount + 1);

      console.log(
        `‚úÖ ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏≤ ${email} ‡πÅ‡∏•‡πâ‡∏ß (‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà ${
          currentCount + 1
        } ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)`
      );
    } catch (err) {
      console.error(`‚ùå Error for ${userId}:`, err && err.message, err);
    }
  }

  return {
    statusCode: 200,
    body: "Expiry SNS alert completed with daily email limit",
  };
};
